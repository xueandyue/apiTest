{% extends "base.html" %}
{% block title %}{{ WEB_NAME }}{% endblock %}
{% load staticfiles %}
{% load custom_tags %}
{% block content %}
<script>
    var module_value = "{{info.belong_module}}"
    module_value = $.trim(module_value);
    function remove_self(id) {
        $(id).remove();
    }
    $(function () {
        $("#pre_case").sortable();
        $("#pre_case").disableSelection();
    });
    $("li[name='pre_config'] a i").on('click', function () {
        $('#config_pre').val("");
    });

</script>
<link rel="stylesheet" type="text/css" href="{% static 'bootstrap-tree/css/bootstrap-treeview.css' %}">
<script src="{% static 'bootstrap-tree/js/bootstrap-treeview.js' %}" type="text/javascript"></script>
<script>
    $(function () {
        $('#tree').treeview({
            data: getTree(),//节点数据
            onNodeSelected: function (event, node) {//选中节点时调用的方法

            if (typeof ($('#tree').treeview('getSelected')[0].nodes) != "undefined") {
            //这里判断当前节点下是否有值了，有就不再添加数据return防止重复添加
            //$('#tree').treeview('getSelected')取得当前选中的数据
            if ($('#tree').treeview('getSelected')[0].nodes.length > 0) {
                return;
            }
           }


                var level_sum = getLevel(node, 1);  //节点层数
                // alert(node.text);

                if (level_sum == 1) {
                    project_one_change($.trim(node.text), "/Index/add_case/", node.nodeId);
                }
                if (level_sum == 2) {
                    var pnode = $('#tree').treeview('getNode', node.parentId);
                    var one_config_project = pnode.text;
                    one_config_project = one_config_project.replace('项目：', '');
                    one_config_project = $.trim(one_config_project);

                    var one_moudle_id = $.trim(node.id);

                    moudle_one_change(one_config_project, one_moudle_id, "/Index/add_case/", node.nodeId);
                }

                if (level_sum == 3) {


                    var one_config_id = $.trim(node.id);
                    var one_config_name = node.text;
                    one_config_name = one_config_name.replace('项目：', '');
                    one_config_name = $.trim(one_config_name);



                    var case_id = one_config_id;
                    var case_name = one_config_name;

                    var href = "<li disbaled id=" + case_id + " name='pre_config' > <div style=\"float: left;\"><img src=\"{% static 'img/peizhi.jpg' %}\" width=\"20px;\" height=\"100%;\"></div><a class='config_class' style='color: cadetblue;margin-left: 30px;' href='/Index/edit_config/" + case_id + "/' id = " + case_id + ">" + case_name + "" +
                        "</a><i class=\"js-remove\" onclick=remove_self('#" + case_id + "')>✖</i></li>";
                    $("li[name='pre_config']").remove();
                    $("#pre_case").prepend(href);
                    $('#config_pre').val("{'config': ['" + case_id + "', '" + case_name + "']}");

                }
                if (node.nodes != null) {
                    var select_node = $('#tree').treeview('getSelected');
                    if (select_node[0].state.expanded) {
                        $('#tree').treeview('collapseNode', select_node);
                        select_node[0].state.selected = false;
                    }
                    else {
                        $('#tree').treeview('expandNode', select_node);
                        select_node[0].state.selected = false;
                    }
                }



            },
            // onNodeExpanded: function (event, node) {
            //     getChildCom(node.comId, node.nodeId);

            // },
            selectedIcon: "glyphicon glyphicon-ok", //节点被选中时显示的图标       string,
            // showCheckbox : true,
            levels: 0,




        });


        $('#tree2').treeview({
            data: getTree(),//节点数据
            onNodeSelected: function (event, node) {//选中节点时调用的方法

                var level_sum = getLevel2(node, 1);  //节点层数
                // alert(node.text);

                if (level_sum == 1) {
                    project_two_change($.trim(node.text), "/Index/add_case/", node.nodeId);
                }
                if (level_sum == 2) {
                    var pnode = $('#tree2').treeview('getNode', node.parentId);
                    var one_config_project = pnode.text;
                    one_config_project = one_config_project.replace('项目：', '');
                    one_config_project = $.trim(one_config_project);

                    var one_moudle_id = $.trim(node.id);

                    moudle_two_change(one_config_project, one_moudle_id, "/Index/add_case/", node.nodeId);
                }

                if (level_sum == 3) {

                    var two_case_id = $.trim(node.id);
                    var two_case_name = node.text;
                    two_case_name = two_case_name.replace('项目：', '');
                    two_case_name = $.trim(two_case_name);







                    var case_id = two_case_id;
                    var case_name = two_case_name;

                    //先判断是否存在，若存在则删除再加
                    $("#pre_case li").each(function (index, el) {

                        var id1 = $.trim($(this).attr("id"));
                        if (id1 == case_id) {
                            var str = "#" + case_id;
                            remove_self(str);
                        }

                    });

                    var href = "<li class='pre_testcase_class' style=\"height: 20px;padding-top: 3px;\" id=" + case_id + "> <div style=\"width: 20px;height: 20px;float:left;margin: 0 auto;border-radius: 10px;background-color: #0f9ae0;\"></div><div><a style=\"margin-left: 30px;\" href='/Index/edit_case/" + case_id + "/' id = " + case_id + ">" + case_name + "" +
                        "</a></div><i class=\"js-remove\" onclick=remove_self('#" + case_id + "')>✖</i></li>";
                    $("#pre_case").append(href);

                }


                if (node.nodes != null) {
                    var select_node = $('#tree2').treeview('getSelected');
                    if (select_node[0].state.expanded) {
                        $('#tree2').treeview('collapseNode', select_node);
                        select_node[0].state.selected = false;
                    }
                    else {
                        $('#tree2').treeview('expandNode', select_node);
                        select_node[0].state.selected = false;
                    }
                }

                // return;





            },
            // onNodeExpanded: function (event, node) {
            //     getChildCom(node.comId, node.nodeId);

            // },
            selectedIcon: "glyphicon glyphicon-ok", //节点被选中时显示的图标       string,
            // showCheckbox : true,
            levels: 0,
            multiSelect: true,



        });



    })


    function getLevel(node, sum) {

        if (node.parentId === undefined) {
            return sum;
        }
        sum++;
        var pnode = $('#tree').treeview('getNode', node.parentId);
        return getLevel(pnode, sum);


    }

    function getLevel2(node, sum) {

        if (node.parentId === undefined) {
            return sum;
        }
        sum++;
        var pnode = $('#tree2').treeview('getNode', node.parentId);
        return getLevel(pnode, sum);


    }



    function getTree() {
        //节点上的数据遵循如下的格式：
        var tree = [];
        $(".tree_one_project").each(function (index, el) {
            var tree_one_project_data = $.trim($(this).text());
            var project_tree = {
                text: "项目：" + tree_one_project_data,
                comId: index.toString(),
                nodes: [],
            }
            tree.push(project_tree);
        });


        // var tree = [{
        //     text: "Node 1", //节点显示的文本值  string
        //     // icon: "glyphicon glyphicon-play-circle", //节点上显示的图标，支持bootstrap的图标  string
        //     // selectable: true, //标记节点是否可以选择。false表示节点应该作为扩展标题，不会触发选择事件。  string
        //     state: { //描述节点的初始状态    Object
        //         // checked: true, //是否选中节点
        //         /*disabled: true,*/ //是否禁用节点
        //         // expanded: true, //是否展开节点
        //         // selected: true //是否选中节点
        //     },
        //     style: "node-checked",
        //     nodes: [],
        //     comId: "1"
        // }, {
        //     showCheckbox: true,
        //     text: "Parent 5",
        //     nodes: [],
        //     comId: "2"

        // }];

        return tree;
    }

    //获取子节点信息
    function getChildCom(cmpId, nodeId, level_sum) {
        if (!cmpId) {
            return false;
        }
        if (typeof ($('#tree').treeview('getSelected')[0].nodes) != "undefined") {
            //这里判断当前节点下是否有值了，有就不再添加数据return防止重复添加
            //$('#tree').treeview('getSelected')取得当前选中的数据
            if ($('#tree').treeview('getSelected')[0].nodes.length > 0) {
                return;
            }
        }



        var data = { cmpId: cmpId }
        var url = '/Index/getjson/';
        $.ajax({
            processData: false,  // 告诉jQuery不要去处理发送的数据
            contentType: false,  // 告诉jQuery不要去设置Content-Type请求头
            type: "POST",
            url: url,
            dataType: "json",
            data: data,
            success: function (r) {
                if (r.code == 0) {
                    $.each(r.data, function (index, item) {
                        var addNodes = new Array();
                        addNodes[0] = nodeId;
                        addNodes[1] = {
                            node: {
                                text: item.name,
                                // comId: item.id,level:"0",
                                state: {
                                    expanded: true, //是否展开节点

                                },

                            }
                        };
                        $("#tree").treeview("addNode", addNodes);





                    });
                }
            }
        });
    }

    function project_one_change(project, url, nodeId) {
        var temp_project = $.trim(project);
        temp_project = temp_project.replace('项目：', '');
        temp_project = $.trim(temp_project);
        var data = { "test": { "name": { "project": temp_project }, "type": "module" } };
        $.ajax({
            type: 'post',
            url: url,
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (data) {
                module_info = data.split('replaceFlag');
                for (var i = 0; i < module_info.length; i++) {
                    if (module_info[i] !== "") {
                        var value = module_info[i].split('^=');
                        var addNodes = new Array();
                        addNodes[0] = nodeId;
                        addNodes[1] = {
                            node: {
                                text: "模块：" + value[1],
                                comId: value[0],
                                id: value[0],
                                state: {
                                    expanded: true, //是否展开节点

                                },

                            }
                        };
                        $("#tree").treeview("addNode", addNodes);
                    }
                }


            },
            error: function () {
                myAlert('Sorry，服务器可能开小差啦, 请重试!');
            }
        });



    }

    function project_two_change(project, url, nodeId) {
        if (typeof ($('#tree2').treeview('getSelected')[0].nodes) != "undefined") {
            //这里判断当前节点下是否有值了，有就不再添加数据return防止重复添加
            //$('#tree').treeview('getSelected')取得当前选中的数据
            if ($('#tree2').treeview('getSelected')[0].nodes.length > 0) {
                return;
            }
        }
        var temp_project = $.trim(project);
        temp_project = temp_project.replace('项目：', '');
        temp_project = $.trim(temp_project);
        var data = { "test": { "name": { "project": temp_project }, "type": "module" } };
        $.ajax({
            type: 'post',
            url: url,
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (data) {
                module_info = data.split('replaceFlag');
                for (var i = 0; i < module_info.length; i++) {
                    if (module_info[i] !== "") {
                        var value = module_info[i].split('^=');
                        var addNodes = new Array();
                        addNodes[0] = nodeId;
                        addNodes[1] = {
                            node: {
                                text: "模块：" + value[1],
                                comId: value[0],
                                id: value[0],
                                state: {
                                    expanded: true, //是否展开节点

                                },

                            }
                        };
                        $("#tree2").treeview("addNode", addNodes);
                    }
                }


            },
            error: function () {
                myAlert('Sorry，服务器可能开小差啦, 请重试!');
            }
        });



    }


    function moudle_one_change(project, module_id, url, nodeId) {


        

        var data = { "test": { "name": { "project": project, "module": module_id }, "type": "config" } };
        $.ajax({
            type: 'post',
            url: url,
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (data) {
                case_info = data.split('replaceFlag');
                for (var i = 0; i < case_info.length; i++) {
                    if (case_info[i] !== "") {
                        var value = case_info[i].split('^=');

                        var addNodes = new Array();
                        addNodes[0] = nodeId;
                        addNodes[1] = {
                            node: {
                                text: "可选配置：" + value[1],
                                comId: value[0],
                                id: value[0],
                                state: {
                                    expanded: true, //是否展开节点

                                },

                            }
                        };
                        $("#tree").treeview("addNode", addNodes);



                    }
                }



            }
            ,
            error: function () {
                myAlert('Sorry，服务器可能开小差啦, 请重试!');
            }
        });



    }

    function moudle_two_change(project, module_id, url, nodeId) {
        if (typeof ($('#tree2').treeview('getSelected')[0].nodes) != "undefined") {
            //这里判断当前节点下是否有值了，有就不再添加数据return防止重复添加
            //$('#tree').treeview('getSelected')取得当前选中的数据
            if ($('#tree2').treeview('getSelected')[0].nodes.length > 0) {
                return;
            }
           }
        var data = { "test": { "name": { "project": project, "module": module_id }, "type": "case" } };
        $.ajax({
            type: 'post',
            url: url,
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (data) {
                case_info = data.split('replaceFlag');
                for (var i = 0; i < case_info.length; i++) {
                    if (case_info[i] !== "") {
                        var value = case_info[i].split('^=');

                        var addNodes = new Array();
                        addNodes[0] = nodeId;
                        addNodes[1] = {
                            node: {
                                text: "前置用例：" + value[1],
                                comId: value[0],
                                id: value[0],
                                state: {
                                    expanded: true, //是否展开节点

                                },

                            }
                        };
                        $("#tree2").treeview("addNode", addNodes);



                    }
                }



            }
            ,
            error: function () {
                myAlert('Sorry，服务器可能开小差啦, 请重试!');
            }
        });



    }





</script>

<div id="tree_project" style="display: none;">
    <ul>
        {% for foo in project %}
        <li class="tree_one_project">{{ foo.project_name }}</li>
        {% endfor %}

    </ul>

</div>
<div class="am-modal am-modal-prompt" tabindex="-1" id="my-copy">
    <div class="am-modal-dialog">
        <div style="font-size: medium;" class="am-modal-hd">{{WEB_NAME}}</div>
        <div class="am-modal-bd">
            <form class="form-horizontal" id="copy_list">
                <div class="form-group">
                    <label class="control-label col-sm-3" for="index" style="font-weight: inherit; font-size: small "
                        hidden>索引值:</label>
                    <div class="col-sm-9">
                        <input name="index" type="text" class="form-control" id="index" placeholder="索引值" value=""
                            hidden>
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label col-sm-3" for="name"
                        style="font-weight: inherit; font-size: small ">用例名称:</label>
                    <div class="col-sm-9">
                        <input name="name" type="text" class="form-control" id="name" placeholder="给用例起个名吧" value="">
                    </div>
                </div>

            </form>
        </div>
        <div class="am-modal-footer">
            <span class="am-modal-btn" data-am-modal-cancel>取消</span>
            <span class="am-modal-btn" data-am-modal-confirm>提交</span>
        </div>
    </div>
</div>
<div class="am-modal am-modal-confirm" tabindex="-1" id="my-invalid">
    <div class="am-modal-dialog">
        <div class="am-modal-hd">{{ WEB_NAME }}</div>
        <div class="am-modal-bd">
            亲，请确认该用例是否被其他用例依赖后再谨慎删除哦
        </div>
        <div class="am-modal-footer">
            <span class="am-modal-btn" data-am-modal-cancel>取消</span>
            <span class="am-modal-btn" data-am-modal-confirm>确定</span>
        </div>
    </div>
</div>

<div class="am-modal am-modal-confirm" tabindex="-1" id="my-delete">
    <div class="am-modal-dialog">
        <div class="am-modal-hd">{{ WEB_NAME }}</div>
        <div class="am-modal-bd">
            亲，请确认该用例是否被其他用例依赖后再谨慎删除哦
        </div>
        <div class="am-modal-footer">
            <span class="am-modal-btn" data-am-modal-cancel>取消</span>
            <span class="am-modal-btn" data-am-modal-confirm>确定</span>
        </div>
    </div>
</div>

<div class="am-modal am-modal-confirm" tabindex="-1" id="select_env_submit">
    <div class="am-modal-dialog">
        <div class="am-modal-hd">接口测试自动化平台</div>
        <form class="form-horizontal">
            <div class="form-group">
                <label class="control-label col-sm-3" style="font-weight: inherit; font-size: small ">运行环境:</label>
                <div class="col-sm-8">
                    <select class="form-control" id="env_name_submit" name="env_name_submit">
                        <option value="">自带环境</option>
                        {% for foo in env %}
                        <option value="{{ foo.base_url }}">{{ foo.env_name }}</option>
                        {% endfor %}

                    </select>
                </div>
            </div>
        </form>
        <div class="am-modal-footer">
            <span class="am-modal-btn" data-am-modal-cancel>取消</span>
            <span class="am-modal-btn" data-am-modal-confirm>确定</span>
        </div>
    </div>
</div>


 <div class="am-modal am-modal-confirm am-modal-active" tabindex="-1" id="select_env" style="top: 10%;left: 40%;width: 60%;height: 500px;display: none;overflow: scroll;background-color: #f8f8f8;">
    <div class="am-modal-dialog">
        <div class="am-modal-hd">{{WEB_NAME}}</div>




        <div style="width: 100%;">
            <form class="form-horizontal">
                <input id="project" style="display: none;" />

                <div class="form-group">
                    <div class="input-group col-md-10 col-md-offset-1">
                        <div class="input-group-addon" style="color: #0a628f">运行环境:</div>
                        <select class="form-control" id="env_name" name="env_name">
                            <option value="">自带环境</option>
                            {% for foo in env %}
                            <option value="{{ foo.base_url }}">{{ foo.env_name }}</option>
                            {% endfor %}

                        </select>
                    </div>
                </div>



                <div class="form-group">
                    <div class="input-group col-md-10 col-md-offset-1" style="text-align: left;">
                        <button type="button" class="btn btn-info am-icon-plus" id="config_button"
                            title="隐藏/展开">可选配置</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="input-group col-md-10 col-md-offset-1">
                        <div id="tree_body" style="height:300px;text-align: left;overflow: scroll;display: none;">

                            <div id="tree"></div>
                        </div>
                    </div>
                </div>



                <div class="form-group">
                    <div class="input-group col-md-10 col-md-offset-1" style="text-align: left;">
                        <button type="button" class="btn btn-info am-icon-plus" id="case_button"
                            title="隐藏/展开">前置用例</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="input-group col-md-10 col-md-offset-1">
                        <div id="tree_body_2" style="height:300px;text-align: left;overflow: scroll;display: none;">

                            <div id="tree2"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-group col-md-10 col-md-offset-1"">
            
                                <div class=" input-group-addon " id=" close_collapse" style="color: #0a628f;">前置配置与用例列表
                    </div>

                    <a class="am-btn am-btn-primary am-radius am-btn-block" href="#" id="pre_collapse"
                        style="font-size: 16px; background-color: #fff; color: #555; text-align: left;"
                        data-am-collapse="{target: '#pre_case'}">
                        执 行 顺 序
                    </a>
                    <nav>
                        <ul id="pre_case" class="am-nav" ">
                        </ul>
                    </nav>

                </div>
        </div>


        <div class="form-group" style="display: none;">
            <div class="input-group col-md-10 col-md-offset-1" id="config_div">
                <div class="input-group-addon" style="color: #0a628f">可选配置</div>
                <input type="text" value="点击选择" class="form-control" id="config_iput" />
                <select id="config" name="config" class="form-control" style="display: none;">
                </select>
            </div>
        </div>

        <div class="form-group" style="display: none;">
            <div class="input-group col-md-10 col-md-offset-1" id="belong_case_id_div">
                <div class="input-group-addon" style="color: #0a628f">前置用例</div>
                <input type="text" value="点击选择" class="form-control" id="belong_case_id_iput" />
                <select id="belong_case_id" name="include" class="form-control" style="display: none;">
                </select>
            </div>
        </div>




        </form>
    </div>
    <!-- <div style="width: 100%;">
            <div class="form-group">
                <div class="input-group col-md-10">

                    <div class="input-group-addon" id="close_collapse" style="color: #0a628f;">前置配置与用例列表
                    </div>

                    <a class="am-btn am-btn-primary am-radius am-btn-block" href="#" id="pre_collapse"
                        style="font-size: 16px; background-color: #fff; color: #555; text-align: left;width: 400px;display: none;"
                        data-am-collapse="{target: '#pre_case'}">
                        执 行 顺 序
                    </a>
                    <nav>
                        <ul id="pre_case" class="am-nav" style="width: 400px;">
                        </ul>
                    </nav>

                </div>
            </div>
        </div> -->

    <div class="am-modal-footer" style="clear: both;margin: 0 auto;border: 1px solid #dedede;width: 50%;margin-top: 100px;">
        <span class="am-modal-btn" data-am-modal-cancel>取消</span>
        <span class="am-modal-btn" data-am-modal-confirm>确定</span>
    </div>
</div>

</div>

<div class="am-modal am-modal-confirm" tabindex="-1" id="select_config" style="top: 20%;left: 30%;">
    <div class="am-modal-dialog">
        <div class="am-modal-hd">接口测试自动化平台</div>
        <div class="form-group" style="margin-top: 10px;overflow: hidden;">
            <label class="control-label col-sm-3" style="font-weight: inherit; font-size: small ">选择项目:</label>
            <div class="col-sm-8">
                <select class="form-control" id="select_config_project">
                    <option value="请选择">模块选择</option>
                    {% for foo in project %}
                    <option value="{{ foo.project_name }}">{{ foo.project_name }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>

        <div class="form-group" style="margin-top: 10px;overflow: hidden;">
            <label class="control-label col-sm-3" style="font-weight: inherit; font-size: small ">选择模块:</label>
            <div class="col-sm-8">
                <select class="form-control" id="select_config_moudle">
                </select>
            </div>

        </div>
        <div class="form-group" style="margin-top: 10px;overflow: hidden;">
            <label class="control-label col-sm-3" style="font-weight: inherit; font-size: small ">选择配置:</label>
            <div class="col-sm-8">
                <select class="form-control" id="select_config_config">
                </select>
            </div>

        </div>



        <div class="am-modal-footer">
            <span class="am-modal-btn" data-am-modal-cancel>取消</span>
            <span class="am-modal-btn" id="select_config_confirm">确定</span>
        </div>
    </div>
</div>
<div class="am-modal am-modal-confirm" tabindex="-1" id="select_case" style="top: 20%;left: 30%;">
    <div class="am-modal-dialog">
        <div class="am-modal-hd">接口测试自动化平台</div>
        <div class="form-group" style="margin-top: 10px;overflow: hidden;">
            <label class="control-label col-sm-3" style="font-weight: inherit; font-size: small ">选择项目:</label>
            <div class="col-sm-8">
                <select class="form-control" id="select_case_project">
                    <option value="请选择">请选择</option>
                    {% for foo in project %}
                    <option value="{{ foo.project_name }}">{{ foo.project_name }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>

        <div class="form-group" style="margin-top: 10px;overflow: hidden;">
            <label class="control-label col-sm-3" style="font-weight: inherit; font-size: small ">选择模块:</label>
            <div class="col-sm-8">
                <select class="form-control" id="select_case_moudle">
                </select>
            </div>

        </div>
        <div class="form-group" style="margin-top: 10px;overflow: hidden;">
            <label class="control-label col-sm-3" style="font-weight: inherit; font-size: small ">选择用例:</label>
            <div class="col-sm-8">
                <select class="form-control" id="select_case_case">
                </select>
            </div>

        </div>



        <div class="am-modal-footer">
            <span class="am-modal-btn" data-am-modal-cancel>取消</span>
            <span class="am-modal-btn" id="select_case_confirm">确定</span>
        </div>
    </div>
</div>



<div class="admin-biaogelist">
    <div class="listbiaoti am-cf">
        <ul class="am-icon-flag on"> 用例列表</ul>
        <dl class="am-icon-home" style="float: right;"> 当前位置： 用例管理 > <a href="#">用例展示</a></dl>
        <dl>
            <button type="button" class="am-btn am-btn-primary am-round am-btn-xs am-icon-plus"
                onclick="location='{{ADD_CASE_URL}}/'">新增用例
            </button>
            <button type="button" class="am-btn am-btn-warning am-round am-btn-xs am-icon-plus"
                onclick="location='{{ADD_CONFIG_URL}}/'">新增配置
            </button>
            <!-- <button type="button" class="am-btn am-btn-danger am-round am-btn-xs am-icon-bug" onclick="my_submit()">运行
            </button> -->

            <button type="button" class="am-btn am-btn-danger am-round am-btn-xs am-icon-bug"
                onclick="alldelete()">批量删除</button>
        </dl>
    </div>

    <div class="am-btn-toolbars am-btn-toolbar am-kg am-cf">
        <form id="pro_filter" method="post" action="{{TEST_LIST_URL}}/1/">
            <ul>
                <li style="padding-top: 5px">
                    <select name="project" class="am-input-zm am-input-xm" id="pro_filter_project"
                        onchange="auto_load_pro_filter_module('#pro_filter', '{{ADD_CASE_URL}}/', '#module', 'module')">
                        {% if info.belong_project != 'All' %}
                        <option value="{{ info.belong_project }}" selected>{{ info.belong_project }}</option>
                        {% else %}
                        <option value="{{ info.belong_project }}" selected>All项目</option>
                        {% endif %}
                        {% for foo in project %}
                        {% ifnotequal info.belong_project foo.project_name %}
                        <option value="{{ foo.project_name }}">{{ foo.project_name }}</option>
                        {% endifnotequal %}

                        {% endfor %}
                        {% if info.belong_project != 'All' %}
                        <option value="All">All项目</option>
                        {% endif %}
                    </select>
                </li>

                <li style="padding-top: 5px">
                    <select name="module" class=" am-input-zm am-input-xm" id="module">
                    </select>
                </li>

                <li style="padding-top: 5px">
                    <select name="import_type" class=" am-input-zm am-input-xm" id="import_type">
                        <option value="0">用例类型</option>
                        <option value="1">testcase</option>
                        <option value="3">api</option>
                    </select>
                </li>

                <li style="padding-top: 5px"><input value="{{ info.name }}" type="text" name="name"
                        class=" am-input-zm am-input-xm" placeholder="用例名称" id="pro_filter_name" /></li>
                <li>
                <li style="padding-top: 5px"><input value="{{ info.user }}" type="text" name="user" id="pro_filter_user"
                        class="am-input-sm am-input-xm" placeholder="创建者" />
                </li>
                <li>
                    <button style="padding-top: 5px; margin-top: 9px"
                        class="am-btn am-radius am-btn-xs am-btn-success">搜索
                    </button>
                    <!-- <button style="padding-top: 5px; margin-top: 9px"
                        class="am-btn am-radius am-btn-xs am-btn-success" id="qingkong">清空
                    </button> -->
                </li>
            </ul>
        </form>
    </div>

    <!-- <div style="width:500px; height:500px;overflow-x: scroll;" class="row pre-scrollable">
        <div id="tree"></div>
    </div> -->


    <form class="am-form am-g" id='test_list' name="test_list">
        <table width="100%" class="am-table am-table-bordered am-table-radius am-table-striped">
            <thead>
                <tr class="am-success">
                    <th class="table-check"><input type="checkbox" id="select_all" /></th>
                    <th class="table-title">序号</th>
                    <th class="table-type">名称</th>
                    <th class="table-type">所属项目</th>
                    <th class="table-type">所属模块</th>
                    <th class="table-type">类型</th>
                    <th class="table-type">创建者</th>
                    <th width="163px" class="table-title">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for foo in test %}
                <tr>
                    <td><input class="testcase_class" type="checkbox" name="testcase_{{ foo.id }}"
                            data_project="{{ foo.belong_project}}" value="{{ foo.id }}" /></td>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        {% if foo.include != '[]' %}
                        <div style="float: left">
                            <a id="co{{ foo.id }}" class="am-icon-plus-square-o am-icon-fw"
                                style="display: block; cursor: pointer" onclick="coolspo({{ foo.id }})"></a>
                            <a id="cc{{ foo.id }}" class="am-icon-minus-square-o am-icon-fw"
                                style="display: none; cursor: pointer" onclick="coolspc({{ foo.id }})"></a>
                        </div>

                        {% endif %}

                        <div style="float: left">
                            <a href="/Index/edit_case/{{ foo.id }}/"
                                data-am-collapse="{target: '#pre_case{{ foo.id }}'}">{{ foo.name }}</a>
                            <nav>
                                <ul id="pre_case{{ foo.id }}" class="am-nav am-collapse">
                                    {% for path in foo.include|convert_eval %}
                                    {% if path|data_type != 'list' %}
                                    {% if path.config.1|is_del == True %}
                                    <li id="{{ path.0 }}">
                                        <span style="color: red;">{{ path.config.1 }}</span>
                                    </li>
                                    {% else %}
                                    <li id="{{ path.0 }}">
                                        <a href="/Index/edit_config/{{ path.config.0 }}/" id="{{ path.config.0 }}"
                                            style="color:cadetblue">{{ path.config.1 }}</a>
                                    </li>
                                    {% endif %}

                                    {% else %}
                                    {% if path.1|is_del == True %}
                                    <li id="{{ path.0 }}" s>
                                        <span style="color: red;">{{ path.1 }}</span>
                                    </li>
                                    {% else %}
                                    <li id="{{ path.0 }}">
                                        <a href="/Index/edit_case/{{ path.0 }}/" id="{{ path.0 }}"
                                            style="color:rosybrown">{{ path.1 }}</a>
                                    </li>

                                    {% endif %}

                                    {% endif %}
                                    {% endfor %}
                                </ul>
                            </nav>
                        </div>
                    </td>
                    <td>{{ foo.belong_project }}</td>
                    <td>{{ foo.belong_module.module_name }}</td>
                    <td>
                        {% if foo.type != 1 %}
                        api
                        {% else %}
                        testcase
                        {% endif %}
                    </td>
                    <td>{{ foo.author }}</td>
                    <td>
                        <div class="am-btn-toolbar">
                            <div class="am-btn-group am-btn-group-xs">
                                <button type="button" class="am-btn am-btn-default am-btn-xs am-text-secondary am-round"
                                    data-am-popover="{content: '运行', trigger: 'hover focus'}"
                                    onclick="run_test('{{ foo.id}}','{{ foo.belong_project}}')">
                                    <span class="am-icon-bug"></span>
                                </button>
                                <button type="button" class="am-btn am-btn-default am-btn-xs am-text-danger am-round"
                                    data-am-popover="{content: '复制', trigger: 'hover focus'}"
                                    onclick="copy('#copy_list', '{{ foo.id }}')"><span
                                        class="am-icon-copy"></span></button>
                                <button type="button" class="am-btn am-btn-default am-btn-xs am-text-danger am-round"
                                    data-am-popover="{content: '删除', trigger: 'hover focus'}"
                                    onclick="invalid('{{ foo.id }}')"><span class="am-icon-trash-o"></span></button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- <div class="am-btn-group am-btn-group-xs">
                <button type="button" class="am-btn am-btn-default" onclick="location='{{ADD_CASE_URL}}/'"><span
                        class="am-icon-plus"></span> 新增用例
                </button>
                <button type="button" class="am-btn am-btn-default" onclick="location='{{ADD_CONFIG_URL}}/'"><span
                        class="am-icon-plus"></span> 新增配置
                </button>
            </div> -->
        <div style="overflow: hidden;">

            <ul class="am-pagination am-fr">
                {{ page_list }}
            </ul>
        </div>


        <hr />

    </form>
</div>
<script type="text/javascript">

    function coolspo(id) {
        $('#co' + id).css('display', 'none');
        $('#cc' + id).css('display', 'block');
        $('#pre_case' + id).collapse('open');
    }

    function coolspc(id) {
        $('#co' + id).css('display', 'block');
        $('#cc' + id).css('display', 'none');
        $('#pre_case' + id).collapse('close');
    }

    function my_submit() {




        if ($("input:checked").size() == 0) {
            myAlert("请至少选择一条用例运行！");
        }
        else {


            var arr = [];
            $('.testcase_class').each(function (index, item) {
                if ($(item).prop('checked')) {
                    arr.push($.trim((item).val()));
                }
            });

            for (var i = 1; i < arr.length; i++) {
                if (arr[i - 1] != arr[i]) {
                    myAlert("请选择同一项目的用例！");
                    return false;

                }

            }

            var project = arr[0];


            $('#select_env_submit').modal({
                relatedTarget: this,
                onConfirm: function () {
                    var data = $("#test_list").serializeJSON();
                    var json2map = JSON.stringify(data);
                    var obj = JSON.parse(json2map);
                    obj['env_name'] = $('#env_name_submit').val();
                    obj['project'] = project;
                    post('/Index/run_batch_test/', obj)
                },
                onCancel: function () {
                }
            }
            );
        }
    }

    function invalid(name) {
        var tempname = [];
        tempname.push(name);
        $('#my-invalid').modal({
            relatedTarget: this,
            onConfirm: function () {
                del_data_ajax(tempname, '{{TEST_LIST_URL}}/1/')
            },
            onCancel: function () {
            }
        });
    }

    function alldelete() {

        if ($("input:checked").size() == 0) {
            myAlert("请至少选择一条用例删除！");
            return false;
        }
        else {

            var arr = [];
            $('.testcase_class').each(function (index, item) {
                if ($(item).prop('checked')) {
                    arr.push($(item).val());
                }
            });
        }

        var temp = arr;
        // console.log(name);
        // return false;

        $('#my-delete').modal({
            relatedTarget: this,
            onConfirm: function () {
                del_data_ajax(temp, '{{TEST_LIST_URL}}/1/')
            },
            onCancel: function () {
            }
        });
    }

    function copy(id, index) {
        $('#index').val(index);
        $('#my-copy').modal({
            relatedTarget: this,
            onConfirm: function () {
                copy_data_ajax(id, '{{TEST_LIST_URL}}/1/')
            },
            onCancel: function () {
            }
        });
    }

    function run_test(index, project) {
        $('#select_env').modal({
            relatedTarget: this,
            onConfirm: function () {

                var id = [];
                var id1 = undefined;

                var config_id = $.trim($(".config_class").attr('id'));

                if (!config_id) {

                }
                else {
                    id1 = config_id;
                    id1 = $.trim(id1)
                    id.push(id1)

                }
                $(".pre_testcase_class").each(function (index, el) {

                    var idtemp = $.trim($(this).attr('id'));
                    id.push(idtemp);

                });

                var case_index = index;
                case_index = $.trim(case_index)
                id.push(case_index);


                // id = JSON.stringify(id);
                id = id.join(',');
                // alert(id);

                post('/Index/run_test/', {
                    'id': id,
                    'env_name': $('#env_name').val(),
                    'project': project
                })
            },
            onCancel: function () {
            }
        });
    }

    $('#select_all').click(function () {
        var isChecked = $(this).prop("checked");
        $("input[name^='testcase']").prop("checked", isChecked);
    });

    $().ready(function () {

        $("#select_config_confirm").click(function () {



            var temp = $("#config").find("option:selected").text();
            $("#config_iput").val(temp);



            if ($('#config').val() !== '请选择') {
                var case_id = $('#config').val();
                var case_name = $('#config option:selected').text();

                var href = "<li disbaled id=" + case_id + " name='pre_config' > <div style=\"float: left;\"><img src=\"{% static 'img/peizhi.jpg' %}\" width=\"20px;\" height=\"100%;\"></div><a class='config_class' style='color: cadetblue;margin-left: 30px;' href='/Index/edit_config/" + case_id + "/' id = " + case_id + ">" + case_name + "" +
                    "</a><i class=\"js-remove\" onclick=remove_self('#" + case_id + "')>✖</i></li>";
                $("li[name='pre_config']").remove();
                $("#pre_case").prepend(href);
                $('#config_pre').val("{'config': ['" + case_id + "', '" + case_name + "']}");
            }
            $("#select_env").show();


        });
    });

</script>
<script src="{% static 'assets/js/add_case.js' %}" type="text/javascript"></script>
<script>
    function auto_load_pro_filter_module(id, url, target, type) {
        var data = $(id).serializeJSON();
        if (id === '#form_message' || id === '#belong_message' || id === '#pro_filter') {
            data = {
                "test": {
                    "name": data,
                    "type": type
                }
            }
        }


        $.ajax({
            type: 'post',
            url: url,
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (data) {
                if (type === 'module') {
                    pro_filter_show_module(data, target)
                }
            },
            error: function () {
                myAlert('Sorry，服务器可能开小差啦, 请重试!');
            }
        });

    }


    function pro_filter_show_module(module_info, id) {
        module_info = module_info.split('replaceFlag');
        var Is_select = false;
        var a = $(id);
        a.empty();
        for (var i = 0; i < module_info.length; i++) {
            if (module_info[i] !== "") {
                var value = module_info[i].split('^=');
                if (value[1] !== module_value) {
                    a.prepend("<option value='" + value[0] + "' >" + value[1] + "</option>")

                }
                else {
                    a.prepend("<option  value='" + value[0] + "' selected>" + value[1] + "</option>")
                    Is_select = true;
                }

            }
        }
        if (Is_select) {
            a.prepend("<option value='请选择' >选择模块</option>");

        }
        else {
            a.prepend("<option value='请选择' selected>选择模块</option>");
        }


    }

</script>


<script>


    $(document).ready(function () {

        //   var module ="{{info.belong_module}}"
        //   module=$.trim(module);
        var import_type = "{{info.import_type}}"
        var pro_filter_project = "{{info.belong_project}}";
        var pro_filter_name = "{{info.name}}"
        var pro_filter_user = "{{info.user}}"
        //   $("#module").text("");
        //   if(module=="请选择")
        //   {
        //        str = '<option value="'+module+'" selected="selected">'+"选择模块"+'</option>';
        //       console.log(str);
        //   }
        //   else{
        //      str = '<option value="'+module+'" selected="'+'">'+"module"+'</option>';
        //   }
        //   $("#module").append(str);
        auto_load_pro_filter_module('#pro_filter', '{{ADD_CASE_URL}}/', '#module', 'module');

        $("#import_type").val(import_type);
        $("#pro_filter_name").val(pro_filter_name);
        $("#pro_filter_user").val(pro_filter_user);
        $("#qingkong").click(function () {
            $(':input', '#pro_filter')
                .not(':button, :submit, :reset, :hidden')
                .val('')
                .removeAttr('checked')
                .removeAttr('selected');

        });

        $("#config_button").click(function () {
            if ($("#tree_body").css("display") == "none") {
                $("#tree_body").show();
                $(this).removeClass("am-icon-plus");//删除+号
                $(this).addClass("am-icon-minus");//添加-号

            }
            else {
                $("#tree_body").hide();
                $(this).removeClass("am-icon-minus");//删除+号
                $(this).addClass("am-icon-plus");//添加-号
            }



        });

        $("#case_button").click(function () {
            if ($("#tree_body_2").css("display") == "none") {
                $("#tree_body_2").show();
                $(this).removeClass("am-icon-plus");//删除+号
                $(this).addClass("am-icon-minus");//添加-号


            }
            else {
                $("#tree_body_2").hide();
                $(this).removeClass("am-icon-minus");//删除+号
                $(this).addClass("am-icon-plus");//添加-号
            }



        });







    });

</script>

{% endblock %}